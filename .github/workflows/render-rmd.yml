name: Render Rintro to HTML
run-name: ${{ github.actor }} is testing

on:
  push:
    branches: ["2023.03"] 


jobs:
  
  build:
    name: Conda Tests
    runs-on: ubuntu-latest
    defaults:
       run:
         shell: bash -l {0}
    container: node:latest

    steps:
      - name: Print shell information
        run: |
          echo "Shell: $SHELL"
          echo "Shell version: $($SHELL --version)"
          uname -a || true

      - uses: actions/checkout@v2
      - name: Check yaml
        run: |
          cat conda_config.yml || true
      - uses: conda-incubator/setup-miniconda@v2
        with:
          miniconda-version: "latest"
          channels: bioconda, conda-forge, defaults
          use-only-tar-bz2: true 
          auto-update-conda: true
          auto-activate-base: true
      - name: Configure conda
        run: |
          conda init bash
          echo ". /opt/conda/etc/profile.d/conda.sh" >> $HOME/.bashrc
          echo "conda activate base" >> $HOME/.bashrc
          cat $HOME/.bashrc
          exec bash
          
      - name: Install Requirements
        run: |
          conda install mamba
          mamba env create -f conda_config.yml 

      - name: Activate Environment
        run: 
          conda activate Rintro2023 || true

      - name: Check Installation
        run: |
          echo "after conda activate Rintro: PATH=$PATH;"
          which R || true
          R --version || true

      - name: Render R Markdown and Move Site
        run: | 
          Rscript -e "rmarkdown::render_site('rmd')"  
          mv rmd/_site .
    
      - name: Deploy to GitHub Pages
        uses: peaceiris/actions-gh-pages@v3
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: ./_site